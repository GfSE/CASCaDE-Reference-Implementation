/**
 * Build Information Generator
 * 
 * Automatically generates build-info.ts with:
 * - Application name and version (from package.json)
 * - Build timestamp
 * - Git commit hash
 * - Git branch name
 * - Working directory status (dirty/clean)
 * 
 * Usage: node scripts/generate-build-info.js
 * Auto-runs: Before build and dev commands (see package.json)
 */

const fs = require('fs');
const path = require('path');

function getPackageInfo() {
    try {
        const packageJsonPath = path.join(__dirname, '../package.json');
        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
        return {
            name: packageJson.name || 'unknown',
            version: packageJson.version || '0.0.0'
        };
    } catch (error) {
        console.warn('âš  Could not read package.json:', error.message);
        return { name: 'unknown', version: '0.0.0' };
    }
}

function getGitInfoFromFiles() {
    try {
        const gitDir = path.join(__dirname, '../.git');

        if (!fs.existsSync(gitDir)) {
            console.warn('âš  .git directory not found');
            return { commit: 'unknown', branch: 'unknown', isDirty: false };
        }

        // Branch lesen
        const headPath = path.join(gitDir, 'HEAD');
        const head = fs.readFileSync(headPath, 'utf8').trim();
        const branch = head.startsWith('ref: refs/heads/')
            ? head.replace('ref: refs/heads/', '')
            : 'detached';

        // Commit-Hash lesen
        const refPath = path.join(gitDir, head.replace('ref: ', ''));
        const commit = fs.existsSync(refPath)
            ? fs.readFileSync(refPath, 'utf8').trim().substring(0, 7)
            : 'unknown';

        return { commit, branch, isDirty: false };
    } catch (error) {
        console.warn('âš  Could not read Git information:', error.message);
        return { commit: 'unknown', branch: 'unknown', isDirty: false };
    }
}

function generateBuildInfo() {
    console.log('\nðŸ”§ Generating build information...');

    const pkg = getPackageInfo();
    const git = getGitInfoFromFiles();
    const buildTime = new Date().toISOString();

    const content = `// Auto-generated by scripts/generate-build-info.js - DO NOT EDIT
// Generated at: ${buildTime}

export const BUILD_INFO = {
    // from package.json:
    appName: '${pkg.name}',
    appVersion: '${pkg.version}',
    // from Git:
    buildTime: '${buildTime}',
    gitCommit: '${git.commit}',
    gitBranch: '${git.branch}',
    gitDirty: ${git.isDirty}
};
`;

    const outputPath = path.join(__dirname, '../src/build-info.ts');
    fs.writeFileSync(outputPath, content, 'utf8');
    console.log(`âœ“ Build info generated: ${outputPath}\n  App: ${pkg.name} v${pkg.version}\n  Branch: ${git.branch}\n  Commit: ${git.commit}${git.isDirty ? ' (dirty)' : ''}\n  Time: ${buildTime}\n`);
}

generateBuildInfo();
